{{ define "models-go" }}
// Code generated by goapi. DO NOT EDIT.
{{ include "package" . }}

{{- range $key, $schema := .Doc.Components.Schemas }}

// {{ $key }}{{ with $schema.Description }}: {{ . }}{{ end }}
type {{ $key }} {{ include "schema-type" (dict "schema" $schema "required" true) }}
{{- end }}
{{- end }}

{{ define "go-safe-field-name" }}
{{- regexReplaceAll ":" . "_" | toGoPascalCase }}
{{- end }}

{{ define "schema-type" }}
{{- $schema := get . "schema" }}
{{- $reqd := get . "required" }}
{{- $tag := get . "tag" }}
{{- with $schema }}
  {{- with get .Extensions "x-go-type" }}
    {{- if not $reqd }}*{{ end }}{{ . }}
  {{- else }}
    {{- if eq .Type "string" }}{{ include "string-type" (dict "schema" $schema "required" $reqd) }}
    {{- else if eq .Type "integer" }}{{ include "integer-type" (dict "schema" $schema "required" $reqd) }}
    {{- else if eq .Type "number" }}{{ include "number-type" (dict "schema" $schema "required" $reqd) }}
    {{- else if eq .Type "boolean" }}{{ include "boolean-type" (dict "schema" $schema "required" $reqd) }}
    {{- else if eq .Type "object" }}{{ include "object-type" (dict "schema" $schema "required" $reqd) }}
    {{- else if eq .Type "array" }}{{ include "array-type" (dict "schema" $schema) }}
    {{- else }}any
    {{- end }}
  {{- end }}
{{- else }}any
{{- end }}
{{- end }}


{{ define "object-type" }}
{{- $schema := get . "schema" }}
{{- $reqd := get . "required" }}
{{- $requiredFields := $schema.Required }}
{{- with $schema.Properties }}
{{- if not $reqd }}*{{ end }}struct {
  {{- range $key, $item := . }}
  {{- $childReqd := has $key $requiredFields }}
  {{- $tags := list }}
  {{- if get $schema.Extensions "x-goapi-query-schema" }}
  {{- $tags = append $tags (include "query-tag" (dict "key" $key)) }}
  {{- else }}
  {{- $tags = append $tags (include "json-tag" (dict "key" $key "required" $childReqd)) }}
  {{- end }}
  {{- $tags = append $tags (include "validate-tag" (dict "ref" $item "required" $childReqd)) }}
  {{- with $item.Value }}
  {{- with .Description }}

  // {{ . }}
  {{- end }}
  {{- end }}
  {{ include "go-safe-field-name" $key }} {{ include "ref-type" (dict "ref" $item "required" $childReqd "tag" $key) }} `{{ $tags | join " " }}`
  {{- end }}
}
{{- else }}
{{- if not $reqd }}*{{ end }}map[string]interface{}
{{- end }}
{{- end }}

{{ define "array-type" }}
{{- $schema := get . "schema" }}
{{- with $schema.Items }}[]{{ include "ref-type" (dict "ref" . "required" true) }}
{{- else}}interface{}
{{- end }}
{{- end }}

{{ define "string-type" }}
{{- $schema := get . "schema" }}
{{- $reqd := get . "required" }}
{{- if eq $schema.Format "date-time" }}
{{- if not $reqd }}*{{ end }}time.Time
{{- else }}
{{- if not $reqd }}*{{ end }}string
{{- end }}
{{- end }}

{{ define "number-type" }}
{{- $schema := get . "schema" }}
{{- $reqd := get . "required" }}
{{- if not $reqd }}*{{ end }}float64
{{- end }}

{{ define "integer-type" }}
{{- $schema := get . "schema" }}
{{- $reqd := get . "required" }}
{{- if not $reqd }}*{{ end }}int
{{- end }}

{{ define "boolean-type" }}
{{- $schema := get . "schema" }}
{{- $reqd := get . "required" }}
{{- if not $reqd }}*{{ end }}bool
{{- end }}

{{ define "ref-type" }}
{{- $ref := get . "ref" }}
{{- $reqd := get . "required" }}
{{- $tag := get . "tag" }}
{{- if eq $ref.Ref "" }}{{ include "schema-type" (dict "schema" $ref.Value "required" $reqd "tag" $tag) }}
{{- else }}
{{- if not $reqd }}*{{ end }}{{ splitList "/" $ref.Ref | last }}
{{- end }}
{{- end }}

{{ define "json-tag" }}
{{- $key := get . "key" }}
{{- $reqd := get . "required" }}json:"{{ $key }}{{- if not $reqd }},omitempty{{ end }}"
{{- end }}

{{ define "query-tag" }}
{{- $key := get . "key" }}query:"{{ $key }}"
{{- end }}

{{ define "validate-tag" }}
{{- $ref := get . "ref" }}
{{- $reqd := get . "required" }}validate:"{{ include "validate-ref-rule" (dict "ref" $ref "required" $reqd) }}"
{{- end }}


{{ define "validate-ref-rule" }}
{{- $ref := get . "ref" }}
{{- $reqd := get . "required" }}
{{- $rules := list }}
{{- if $reqd }}
{{- $rules = append $rules "required" }}
{{- else }}
{{- $rules = append $rules "omitempty" }}
{{- end }}
{{- with $ref.Value }}
{{- $childRules := include "validate-schema-rule" (dict "schema" $ref.Value) }}
{{- if ne $childRules "" }}
{{- $rules = append $rules $childRules }}
{{- end }}
{{- end }}{{ join "," $rules }}
{{- end }}


{{ define "validate-schema-rule" }}
{{- $schema := get . "schema" }}
{{- $rules := list }}
{{- if eq $schema.Type "string" }}
  {{- if eq $schema.Format "uuid" }}
  {{- $rules = append $rules "uuid" }}
  {{- else if eq $schema.Format "email" }}
  {{- $rules = append $rules "uuid" }}
  {{- else if eq $schema.Format "date-time" }}
  {{- $rules = append $rules "datetime=2006-01-02T15:04:05Z07:00" }}
  {{- end }}
  {{- with $schema.Enum }}
  {{- $rules = append $rules (list "oneof=" (. | join " ") | join "") }}
  {{- end }}
  {{- with $schema.MaxLength }}
  {{- $rules = append $rules (cat "max=" . | nospace) }}
  {{- end }}
  {{- with $schema.MinLength }}
  {{- $rules = append $rules (cat "min=" . | nospace) }}
  {{- end }}
{{- else if eq $schema.Type "integer" }}
  {{- with $schema.Maximum }}
  {{- $rules = append $rules (cat "lte=" . | nospace) }}
  {{- end }}
  {{- with $schema.Minimum }}
  {{- $rules = append $rules (cat "gte=" . | nospace) }}
  {{- end }}
{{- else if eq $schema.Type "array" }}
  {{- $rules = append $rules "dive" }}
  {{- $rules = append $rules (include "validate-ref-rule" (dict "ref" $schema.Items "required" true)) }}
{{- end }}{{ join "," $rules }}
{{- end }}